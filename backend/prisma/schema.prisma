generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum PropertyValueType {
  STRING
  INTEGER
  BOOLEAN
  JSON
  DECIMAL
}

enum CharacterCampaignStatus {
  ACTIVE
  INACTIVE
}

enum SystemViewType {
  LIST
  FORM
}

enum RelatedListFieldSource {
  RELATED
  JOIN
}

enum SystemFieldType {
  TEXT
  TEXTAREA
  NUMBER
  BOOLEAN
  SELECT
  DATE
  EMAIL
  PASSWORD
  REFERENCE
}

enum WorldEntityPermissionScope {
  ARCHITECT
  ARCHITECT_GM
  ARCHITECT_GM_PLAYER
}

enum LocationStatus {
  ACTIVE
  INACTIVE
}

enum EntityFieldType {
  TEXT
  TEXTAREA
  BOOLEAN
  CHOICE
  ENTITY_REFERENCE
  LOCATION_REFERENCE
}

enum LocationFieldType {
  TEXT
  TEXTAREA
  NUMBER
  BOOLEAN
  CHOICE
  ENTITY_REFERENCE
  LOCATION_REFERENCE
}

enum EntityAccessType {
  READ
  WRITE
}

enum EntityAccessScope {
  GLOBAL
  CAMPAIGN
  CHARACTER
}

enum EntityFormSectionLayout {
  ONE_COLUMN
  TWO_COLUMN
}

enum NoteVisibility {
  PRIVATE
  SHARED
  GM
}

enum NoteTagType {
  ENTITY
  LOCATION
}

enum SessionTimelineEntryType {
  NOTE_PUBLISHED
}

enum SessionNoteVisibility {
  SHARED
  PRIVATE
}

enum RelationshipStatus {
  ACTIVE
  EXPIRED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  passwordHash String
  role         Role     @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ownedWorlds        World[]             @relation("WorldOwner")
  ownedCampaigns     Campaign[]          @relation("CampaignOwner")
  worldDelegations   WorldDelegate[]
  campaignDelegation CampaignDelegate[]
  characters         Character[]
  createdEntityTypes EntityType[]        @relation("EntityTypeCreator")
  createdEntities    Entity[]            @relation("EntityCreator")
  createdLocations   Location[]          @relation("LocationCreator")
  systemRoles        SystemUserRole[]
  systemPreferences  SystemUserPreference[]
  listViewPreferences UserListViewPreference[]
  entityTypeListDefaults EntityTypeListViewDefault[] @relation("EntityTypeListDefaults")
  architectWorlds    WorldArchitect[]
  worldGameMasters   WorldGameMaster[]
  worldCampaignAccess WorldCampaignCreator[]
  worldCharacterAccess WorldCharacterCreator[]
  campaignCharacterAccess CampaignCharacterCreator[]
  gmCampaigns        Campaign[]          @relation("CampaignGM")
  createdCampaigns   Campaign[]          @relation("CampaignCreator")
  refreshTokens      RefreshToken[]
  systemAudits       SystemAudit[]
  notesAuthored      Note[]              @relation("NoteAuthor")
  sessionNoteDrafts  SessionNoteDraft[]
  sessionNotesAuthored SessionNote[]     @relation("SessionNoteAuthor")
  createdRelationships Relationship[]    @relation("RelationshipCreator")
}

model World {
  id          String   @id @default(uuid())
  name        String
  description String?
  primaryArchitectId String
  dmLabelKey  String?
  themeKey    String?
  entityPermissionScope WorldEntityPermissionScope @default(ARCHITECT_GM_PLAYER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  primaryArchitect User                @relation("WorldOwner", fields: [primaryArchitectId], references: [id])
  campaigns         Campaign[]
  delegates         WorldDelegate[]
  architects        WorldArchitect[]
  gameMasters       WorldGameMaster[]
  campaignCreators  WorldCampaignCreator[]
  characterCreators WorldCharacterCreator[]
  characters        Character[]
  entityTypes       EntityType[]
  entities          Entity[]
  locationTypes     LocationType[]
  locations         Location[]
  relationshipTypes RelationshipType[]
  relationships     Relationship[]
  sessions          Session[]

  @@index([primaryArchitectId])
}

model Campaign {
  id          String   @id @default(uuid())
  name        String
  description String?
  worldId     String
  ownerId     String
  gmUserId    String
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  world              World                    @relation(fields: [worldId], references: [id])
  owner              User                     @relation("CampaignOwner", fields: [ownerId], references: [id])
  gameMaster         User                     @relation("CampaignGM", fields: [gmUserId], references: [id])
  createdBy          User                     @relation("CampaignCreator", fields: [createdById], references: [id])
  delegates          CampaignDelegate[]
  roster             CharacterCampaign[]
  characterCreators  CampaignCharacterCreator[]
  notes              Note[]
  sessions           Session[]

  @@index([worldId])
  @@index([ownerId])
  @@index([gmUserId])
  @@index([createdById])
}

model Session {
  id         String   @id @default(uuid())
  worldId    String
  campaignId String?
  title      String
  startedAt  DateTime?
  endedAt    DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  world           World                 @relation(fields: [worldId], references: [id])
  campaign        Campaign?             @relation(fields: [campaignId], references: [id])
  notes           SessionNote[]
  drafts          SessionNoteDraft[]
  timelineEntries SessionTimelineEntry[]

  @@index([worldId])
  @@index([campaignId])
}

model SessionNote {
  id        String   @id @default(uuid())
  sessionId String
  authorId  String
  visibility SessionNoteVisibility @default(SHARED)
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session   Session               @relation(fields: [sessionId], references: [id])
  author    User                  @relation("SessionNoteAuthor", fields: [authorId], references: [id])
  references SessionNoteReference[]
  timelineEntries SessionTimelineEntry[]

  @@index([sessionId])
  @@index([authorId])
}

model SessionNoteDraft {
  id          String   @id @default(uuid())
  sessionId   String
  authorId    String
  visibility  SessionNoteVisibility @default(SHARED)
  content     Json
  lastSavedAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session Session @relation(fields: [sessionId], references: [id])
  author  User    @relation(fields: [authorId], references: [id])

  @@unique([sessionId, authorId])
  @@index([authorId])
}

model SessionNoteReference {
  id            String     @id @default(uuid())
  sessionNoteId String
  targetType    NoteTagType
  targetId      String
  label         String
  createdAt     DateTime   @default(now())

  sessionNote SessionNote @relation(fields: [sessionNoteId], references: [id])

  @@index([sessionNoteId])
  @@index([targetType, targetId])
}

model SessionTimelineEntry {
  id        String                 @id @default(uuid())
  sessionId String
  type      SessionTimelineEntryType
  noteId    String?
  createdAt DateTime @default(now())

  session Session     @relation(fields: [sessionId], references: [id])
  note    SessionNote? @relation(fields: [noteId], references: [id])

  @@index([sessionId])
  @@index([noteId])
}

model EntityType {
  id          String   @id @default(uuid())
  worldId     String?
  name        String
  description String?
  isTemplate  Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  world     World?       @relation(fields: [worldId], references: [id])
  createdBy User         @relation("EntityTypeCreator", fields: [createdById], references: [id])
  fields    EntityField[]
  formSections EntityFormSection[]
  referencedByFields EntityField[] @relation("EntityFieldReferenceType")
  entities  Entity[]
  listViewDefault EntityTypeListViewDefault?
  listViewPreferences UserListViewPreference[]
  relationshipTypeRulesFrom RelationshipTypeRule[] @relation("RelationshipRuleFrom")
  relationshipTypeRulesTo RelationshipTypeRule[] @relation("RelationshipRuleTo")

  @@index([worldId])
  @@index([createdById])
}

model LocationType {
  id          String   @id @default(uuid())
  worldId     String
  name        String
  description String?
  icon        String?
  colour      String?
  menu        Boolean  @default(false)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  world       World              @relation(fields: [worldId], references: [id])
  fields      LocationTypeField[]
  parentRules LocationTypeRule[] @relation("LocationTypeParentRule")
  childRules  LocationTypeRule[] @relation("LocationTypeChildRule")
  locations   Location[]

  @@index([worldId])
}

model LocationTypeField {
  id             String           @id @default(uuid())
  locationTypeId String
  fieldKey       String
  fieldLabel     String
  fieldType      LocationFieldType
  required       Boolean          @default(false)
  defaultValue   Json?
  validationRules Json?
  listOrder      Int              @default(0)
  formOrder      Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  locationType LocationType              @relation(fields: [locationTypeId], references: [id])
  choices      LocationTypeFieldChoice[]
  values       LocationFieldValue[]

  @@unique([locationTypeId, fieldKey])
  @@index([locationTypeId])
}

model LocationTypeFieldChoice {
  id                 String   @id @default(uuid())
  locationTypeFieldId String
  value              String
  label              String
  sortOrder          Int?
  pillColor          String?
  textColor          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  field LocationTypeField @relation(fields: [locationTypeFieldId], references: [id])

  @@unique([locationTypeFieldId, value])
  @@index([locationTypeFieldId])
}

model LocationTypeRule {
  id           String   @id @default(uuid())
  parentTypeId String
  childTypeId  String
  allowed      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  parentType LocationType @relation("LocationTypeParentRule", fields: [parentTypeId], references: [id])
  childType  LocationType @relation("LocationTypeChildRule", fields: [childTypeId], references: [id])

  @@unique([parentTypeId, childTypeId])
  @@index([parentTypeId])
  @@index([childTypeId])
}

model EntityField {
  id          String         @id @default(uuid())
  entityTypeId String
  fieldKey    String
  label       String
  fieldType   EntityFieldType
  description String?
  required    Boolean        @default(false)
  listOrder   Int            @default(0)
  formOrder   Int            @default(0)
  formSectionId String?
  formColumn  Int            @default(1)
  referenceEntityTypeId String?
  referenceLocationTypeKey String?
  conditions  Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  entityType           EntityType       @relation(fields: [entityTypeId], references: [id])
  formSection          EntityFormSection? @relation(fields: [formSectionId], references: [id])
  referenceEntityType  EntityType?      @relation("EntityFieldReferenceType", fields: [referenceEntityTypeId], references: [id])
  choices              EntityFieldChoice[]
  values               EntityFieldValue[]

  @@unique([entityTypeId, fieldKey])
  @@index([entityTypeId])
}

model EntityFormSection {
  id          String   @id @default(uuid())
  entityTypeId String
  title       String
  layout      EntityFormSectionLayout @default(ONE_COLUMN)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entityType EntityType @relation(fields: [entityTypeId], references: [id])
  fields     EntityField[]

  @@index([entityTypeId])
}

model UserListViewPreference {
  id           String   @id @default(uuid())
  userId       String
  viewKey      String
  entityTypeId String?
  columnsJson  Json?
  filtersJson  Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id])
  entityType EntityType? @relation(fields: [entityTypeId], references: [id])

  @@unique([userId, viewKey, entityTypeId])
  @@index([userId])
  @@index([viewKey])
}

model EntityTypeListViewDefault {
  id           String   @id @default(uuid())
  entityTypeId String   @unique
  columnsJson  Json?
  filtersJson  Json?
  updatedById  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  entityType EntityType @relation(fields: [entityTypeId], references: [id])
  updatedBy  User?      @relation("EntityTypeListDefaults", fields: [updatedById], references: [id])
}

model EntityFieldChoice {
  id            String   @id @default(uuid())
  entityFieldId String
  value         String
  label         String
  sortOrder     Int?
  pillColor     String?
  textColor     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  entityField EntityField @relation(fields: [entityFieldId], references: [id])

  @@unique([entityFieldId, value])
  @@index([entityFieldId])
}

model Entity {
  id           String   @id @default(uuid())
  worldId      String
  entityTypeId String
  currentLocationId String
  name         String
  description  String?
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  world      World             @relation(fields: [worldId], references: [id])
  entityType EntityType        @relation(fields: [entityTypeId], references: [id])
  currentLocation Location     @relation("EntityCurrentLocation", fields: [currentLocationId], references: [id])
  createdBy  User              @relation("EntityCreator", fields: [createdById], references: [id])
  values     EntityFieldValue[]
  access     EntityAccess[]
  notes      Note[]
  relationshipsFrom Relationship[] @relation("RelationshipFrom")
  relationshipsTo Relationship[] @relation("RelationshipTo")

  @@index([worldId])
  @@index([entityTypeId])
  @@index([currentLocationId])
  @@index([createdById])
}

model Location {
  id              String         @id @default(uuid())
  worldId         String
  name            String
  description     String?
  locationTypeId  String
  parentLocationId String?
  status          LocationStatus @default(ACTIVE)
  metadata        Json?
  createdById     String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  world          World      @relation(fields: [worldId], references: [id])
  locationType   LocationType @relation(fields: [locationTypeId], references: [id])
  parentLocation Location?  @relation("LocationParent", fields: [parentLocationId], references: [id])
  childLocations Location[] @relation("LocationParent")
  createdBy      User       @relation("LocationCreator", fields: [createdById], references: [id])
  currentEntities Entity[]  @relation("EntityCurrentLocation")
  access         LocationAccess[]
  fieldValues    LocationFieldValue[]
  notes          Note[]

  @@index([worldId])
  @@index([locationTypeId])
  @@index([parentLocationId])
  @@index([createdById])
}

model RelationshipType {
  id            String   @id @default(uuid())
  worldId       String
  name          String
  description   String?
  fromLabel     String
  toLabel       String
  pastFromLabel String?
  pastToLabel   String?
  isPeerable    Boolean  @default(false)
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  world         World               @relation(fields: [worldId], references: [id])
  rules         RelationshipTypeRule[]
  relationships Relationship[]

  @@index([worldId])
}

model RelationshipTypeRule {
  id                  String   @id @default(uuid())
  relationshipTypeId  String
  fromEntityTypeId    String
  toEntityTypeId      String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  relationshipType RelationshipType @relation(fields: [relationshipTypeId], references: [id])
  fromEntityType   EntityType       @relation("RelationshipRuleFrom", fields: [fromEntityTypeId], references: [id])
  toEntityType     EntityType       @relation("RelationshipRuleTo", fields: [toEntityTypeId], references: [id])

  @@unique([relationshipTypeId, fromEntityTypeId, toEntityTypeId])
  @@index([relationshipTypeId])
  @@index([fromEntityTypeId])
  @@index([toEntityTypeId])
}

model Relationship {
  id                 String             @id @default(uuid())
  worldId            String
  relationshipTypeId String
  fromEntityId       String
  toEntityId         String
  peerGroupId        String?
  status             RelationshipStatus @default(ACTIVE)
  visibilityScope    EntityAccessScope  @default(GLOBAL)
  visibilityRefId    String?
  createdById        String
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  expiredAt          DateTime?

  world            World            @relation(fields: [worldId], references: [id])
  relationshipType RelationshipType @relation(fields: [relationshipTypeId], references: [id])
  fromEntity       Entity           @relation("RelationshipFrom", fields: [fromEntityId], references: [id])
  toEntity         Entity           @relation("RelationshipTo", fields: [toEntityId], references: [id])
  createdBy        User             @relation("RelationshipCreator", fields: [createdById], references: [id])

  @@unique([worldId, relationshipTypeId, fromEntityId, toEntityId])
  @@index([worldId])
  @@index([relationshipTypeId])
  @@index([fromEntityId])
  @@index([toEntityId])
  @@index([peerGroupId])
}

model EntityFieldValue {
  id          String   @id @default(uuid())
  entityId    String
  fieldId     String
  valueString String?
  valueText   String?
  valueBoolean Boolean?
  valueNumber Float?
  valueJson   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entity Entity    @relation(fields: [entityId], references: [id])
  field  EntityField @relation(fields: [fieldId], references: [id])

  @@unique([entityId, fieldId])
  @@index([entityId])
  @@index([fieldId])
}

model LocationFieldValue {
  id           String   @id @default(uuid())
  locationId   String
  fieldId      String
  valueString  String?
  valueText    String?
  valueBoolean Boolean?
  valueNumber  Float?
  valueJson    Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  location Location         @relation(fields: [locationId], references: [id])
  field    LocationTypeField @relation(fields: [fieldId], references: [id])

  @@unique([locationId, fieldId])
  @@index([locationId])
  @@index([fieldId])
}

model EntityAccess {
  id         String           @id @default(uuid())
  entityId   String
  accessType EntityAccessType
  scopeType  EntityAccessScope
  scopeId    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  entity Entity @relation(fields: [entityId], references: [id])

  @@index([entityId])
  @@index([scopeType, scopeId])
}

model LocationAccess {
  id         String           @id @default(uuid())
  locationId String
  accessType EntityAccessType
  scopeType  EntityAccessScope
  scopeId    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  location Location @relation(fields: [locationId], references: [id])

  @@index([locationId])
  @@index([scopeType, scopeId])
}

model Character {
  id          String   @id @default(uuid())
  name        String
  description String?
  playerId    String
  worldId     String
  statusKey   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  player    User               @relation(fields: [playerId], references: [id])
  world     World              @relation(fields: [worldId], references: [id])
  campaigns CharacterCampaign[]
  notes     Note[]
  noteShares NoteShare[]

  @@index([playerId])
  @@index([worldId])
}

model CharacterCampaign {
  characterId String
  campaignId  String
  status      CharacterCampaignStatus @default(ACTIVE)
  joinedAt    DateTime @default(now())

  character Character @relation(fields: [characterId], references: [id])
  campaign  Campaign  @relation(fields: [campaignId], references: [id])

  @@id([characterId, campaignId])
  @@index([campaignId])
}

model WorldDelegate {
  worldId   String
  userId    String
  grantedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([worldId, userId])
  @@index([userId])
}

model CampaignDelegate {
  campaignId String
  userId     String
  grantedAt  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@id([campaignId, userId])
  @@index([userId])
}

model WorldArchitect {
  worldId   String
  userId    String
  grantedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([worldId, userId])
  @@index([userId])
}

model WorldGameMaster {
  worldId   String
  userId    String
  grantedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([worldId, userId])
  @@index([userId])
}

model WorldCampaignCreator {
  worldId   String
  userId    String
  grantedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([worldId, userId])
  @@index([userId])
}

model WorldCharacterCreator {
  worldId   String
  userId    String
  grantedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([worldId, userId])
  @@index([userId])
}

model CampaignCharacterCreator {
  campaignId String
  userId     String
  grantedAt  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@id([campaignId, userId])
  @@index([userId])
}

model SystemProperty {
  id          String            @id @default(uuid())
  key         String            @unique
  valueType   PropertyValueType
  value       String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model SystemUserPreferenceDefault {
  id          String            @id @default(uuid())
  key         String            @unique
  valueType   PropertyValueType
  value       String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model SystemUserPreference {
  id        String            @id @default(uuid())
  userId    String
  key       String
  valueType PropertyValueType
  value     String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, key])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model SystemChoice {
  id        String   @id @default(uuid())
  listKey   String
  value     String
  label     String
  sortOrder Int?
  isActive  Boolean  @default(true)
  pillColor String?
  textColor String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([listKey, value])
  @@index([listKey])
}

model SystemRole {
  id          String            @id @default(uuid())
  key         String            @unique
  name        String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  users    SystemUserRole[]
  controls SystemRoleControl[]
}

model SystemControl {
  id          String            @id @default(uuid())
  key         String            @unique
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  roles SystemRoleControl[]
}

model SystemUserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User       @relation(fields: [userId], references: [id])
  role SystemRole @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@index([roleId])
}

model SystemRoleControl {
  roleId    String
  controlId String
  createdAt DateTime @default(now())

  role    SystemRole    @relation(fields: [roleId], references: [id])
  control SystemControl @relation(fields: [controlId], references: [id])

  @@id([roleId, controlId])
  @@index([controlId])
}

model SystemView {
  id          String          @id @default(uuid())
  key         String          @unique
  title       String
  entityKey   String
  viewType    SystemViewType
  endpoint    String
  description String?
  adminOnly   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  fields SystemViewField[]
}

model SystemViewField {
  id             String          @id @default(uuid())
  viewId         String
  fieldKey       String
  label          String
  fieldType      SystemFieldType
  listVisible    Boolean         @default(true)
  formVisible    Boolean         @default(true)
  listOrder      Int
  formOrder      Int
  required       Boolean         @default(false)
  readOnly       Boolean         @default(false)
  placeholder    String?
  optionsListKey String?
  referenceEntityKey String?
  referenceLabelField String?
  referenceScope String?
  allowMultiple  Boolean         @default(false)
  width          String?

  view SystemView @relation(fields: [viewId], references: [id])

  @@index([viewId])
  @@unique([viewId, fieldKey])
}

model SystemRelatedList {
  id               String   @id @default(uuid())
  key              String   @unique
  title            String
  parentEntityKey  String
  relatedEntityKey String
  joinEntityKey    String
  parentFieldKey   String
  relatedFieldKey  String
  listOrder        Int      @default(0)
  adminOnly        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  fields SystemRelatedListField[]
}

model SystemRelatedListField {
  id             String                 @id @default(uuid())
  relatedListId  String
  fieldKey       String
  label          String
  source         RelatedListFieldSource
  listOrder      Int
  width          String?

  relatedList SystemRelatedList @relation(fields: [relatedListId], references: [id])

  @@index([relatedListId])
  @@unique([relatedListId, fieldKey, source])
}

model SystemDictionary {
  id                 String          @id @default(uuid())
  entityKey          String
  fieldKey           String
  label              String
  fieldType          SystemFieldType
  referenceEntityKey String?
  isLabel            Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@unique([entityKey, fieldKey])
  @@index([entityKey])
}

model SystemAudit {
  id        String   @id @default(uuid())
  entityKey String
  entityId  String
  action    String
  actorId   String
  details   Json?
  createdAt DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id])

  @@index([entityKey, entityId])
  @@index([actorId])
}

model Note {
  id          String         @id @default(uuid())
  entityId    String?
  locationId  String?
  authorId    String
  campaignId  String?
  characterId String?
  visibility  NoteVisibility @default(SHARED)
  shareWithArchitect Boolean  @default(false)
  body        String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  entity    Entity?   @relation(fields: [entityId], references: [id])
  location  Location? @relation(fields: [locationId], references: [id])
  author    User      @relation("NoteAuthor", fields: [authorId], references: [id])
  campaign  Campaign? @relation(fields: [campaignId], references: [id])
  character Character? @relation(fields: [characterId], references: [id])
  tags      NoteTag[]
  shares    NoteShare[]

  @@index([entityId])
  @@index([locationId])
  @@index([authorId])
  @@index([campaignId])
  @@index([characterId])
}

model NoteShare {
  noteId      String
  characterId String
  createdAt   DateTime @default(now())

  note      Note      @relation(fields: [noteId], references: [id])
  character Character @relation(fields: [characterId], references: [id])

  @@id([noteId, characterId])
  @@index([characterId])
}

model NoteTag {
  id        String     @id @default(uuid())
  noteId    String
  tagType   NoteTagType
  targetId  String
  label     String
  createdAt DateTime   @default(now())

  note Note @relation(fields: [noteId], references: [id])

  @@index([noteId])
  @@index([tagType, targetId])
}
