  app.get("/api/user/preferences", requireAuth, async (req, res) => {
    const user = (req as AuthRequest).user;
    if (!user) {
      res.status(401).json({ error: "Unauthorized." });
      return;
    }
  
    const preferences = await prisma.systemUserPreference.findMany({
      where: { userId: user.id },
      orderBy: { key: "asc" }
    });
    res.json(preferences);
  });

  app.get("/api/user/preferences/defaults", requireAuth, async (_req, res) => {
    const defaults = await prisma.systemUserPreferenceDefault.findMany({
      orderBy: { key: "asc" }
    });
    res.json(defaults);
  });

  app.put("/api/user/preferences/:key", requireAuth, async (req, res) => {
    const user = (req as AuthRequest).user;
    if (!user) {
      res.status(401).json({ error: "Unauthorized." });
      return;
    }
  
    const { key } = req.params;
    const { valueType, value } = req.body as { valueType?: string; value?: string };
  
    if (!valueType || value === undefined) {
      res.status(400).json({ error: "valueType and value are required." });
      return;
    }
  
    if (!Object.values(PropertyValueType).includes(valueType as PropertyValueType)) {
      res.status(400).json({ error: "Invalid valueType." });
      return;
    }
  
    const preference = await prisma.systemUserPreference.upsert({
      where: { userId_key: { userId: user.id, key } },
      update: { valueType: valueType as PropertyValueType, value },
      create: { userId: user.id, key, valueType: valueType as PropertyValueType, value }
    });
    res.json(preference);
  });

  app.delete("/api/user/preferences/:key", requireAuth, async (req, res) => {
    const user = (req as AuthRequest).user;
    if (!user) {
      res.status(401).json({ error: "Unauthorized." });
      return;
    }
  
    await prisma.systemUserPreference.delete({
      where: { userId_key: { userId: user.id, key: req.params.key } }
    });
    res.json({ ok: true });
  });
